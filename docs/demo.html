<html>
<head>
  <title>ChainStock Demo</title>
</head>

<script src="https://unpkg.com/ipfs/dist/index.min.js"></script>  
<script>
//var ipfs = window.IpfsApi("ipfs.infura.io", "5001", {protocol: 'https'})

//var ipfs = window.IpfsApi();

//var ipfs = window.IpfsApi("10.2.19.160", "5001");


//ipfs.files.cat("QmQKznbo2EjpAqumR8QN8mbbuaHXuckWxu4VFoHWScaoXm", function(err, result){
//	console.log(result.toString());
//});

//ipfs.files.add(ipfs.Buffer.from("6x7=42"), function(err,result){
//	console.log(JSON.stringify(result));
//});

</script>
<h1>ChainStock Demo</h1>
<h2 id="status">IPFS Node status: offline</h2>
<h2>请上传图片文件到ChainStock</h2>
<input type="file" id="files" name="files[]" multiple /><br>
<output id="list"></output><br>
<output id="list1">现有文件的合约列表（前10条）<br></output>

<script>
  var files;
  function handleFileSelect(evt) {
    files = evt.target.files; // FileList object

    // files is a FileList of File objects. List some properties.
    var output = [];
    for (var i = 0, f; f = files[i]; i++) {
      if (!f.type.match('image.*')) {
        continue;
      }

      var reader = new FileReader();

      // Closure to capture the file information.
      reader.onload = function(){
      	uploadFile(reader.result)
      }

      // Read in the image file as a data URL.
      reader.readAsArrayBuffer(f);
    }
  }

  function uploadFile(fileData){
  	ipfs.files.add(ipfs.types.Buffer.from(fileData), function(err,result){
		console.log(JSON.stringify(result));
		crc.register(result[0].path, "testAuthor", 0.01e18, function(err,r){
			console.log(r);
			var span = document.createElement('span');
        	span.innerHTML = ["path: " + result[0].path,"contractAddress: " + r].join(",");
        	document.getElementById('list').insertBefore(span, null);
		})
	});
  }

  function regiesterFile(filePath) {
  	var result
	
	return result;
  }

  document.getElementById('files').addEventListener('change', handleFileSelect, false);

  var abi = [
    {
      "constant": true,
      "inputs": [
        {
          "name": "",
          "type": "address"
        }
      ],
      "name": "contractAuthor",
      "outputs": [
        {
          "name": "",
          "type": "address"
        }
      ],
      "payable": false,
      "stateMutability": "view",
      "type": "function"
    },
    {
      "constant": true,
      "inputs": [
        {
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "fileContracts",
      "outputs": [
        {
          "name": "",
          "type": "address"
        }
      ],
      "payable": false,
      "stateMutability": "view",
      "type": "function"
    },
    {
      "constant": true,
      "inputs": [
        {
          "name": "",
          "type": "address"
        },
        {
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "authorContracts",
      "outputs": [
        {
          "name": "",
          "type": "address"
        }
      ],
      "payable": false,
      "stateMutability": "view",
      "type": "function"
    },
    {
      "payable": true,
      "stateMutability": "payable",
      "type": "fallback"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "name": "author",
          "type": "address"
        },
        {
          "indexed": false,
          "name": "authorName",
          "type": "string"
        },
        {
          "indexed": false,
          "name": "price",
          "type": "uint256"
        },
        {
          "indexed": false,
          "name": "crContract",
          "type": "address"
        }
      ],
      "name": "Register",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "name": "from",
          "type": "address"
        },
        {
          "indexed": false,
          "name": "amount",
          "type": "uint256"
        }
      ],
      "name": "Paied",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "name": "crContract",
          "type": "address"
        },
        {
          "indexed": false,
          "name": "title",
          "type": "string"
        },
        {
          "indexed": false,
          "name": "description",
          "type": "string"
        },
        {
          "indexed": false,
          "name": "keywords",
          "type": "string"
        },
        {
          "indexed": false,
          "name": "previewFileHash",
          "type": "string"
        }
      ],
      "name": "UpdateContractInfo",
      "type": "event"
    },
    {
      "constant": false,
      "inputs": [],
      "name": "CopyRightContractRegister",
      "outputs": [],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [
        {
          "name": "fileHash",
          "type": "string"
        },
        {
          "name": "authorName",
          "type": "string"
        },
        {
          "name": "price",
          "type": "uint256"
        }
      ],
      "name": "register",
      "outputs": [
        {
          "name": "_fileContract",
          "type": "address"
        }
      ],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [
        {
          "name": "crContract",
          "type": "address"
        },
        {
          "name": "title",
          "type": "string"
        },
        {
          "name": "description",
          "type": "string"
        },
        {
          "name": "keywords",
          "type": "string"
        },
        {
          "name": "previewFileHash",
          "type": "string"
        }
      ],
      "name": "updateContractInfo",
      "outputs": [],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "constant": true,
      "inputs": [
        {
          "name": "start",
          "type": "uint256"
        },
        {
          "name": "length",
          "type": "uint256"
        }
      ],
      "name": "list",
      "outputs": [
        {
          "name": "_fileContracts",
          "type": "address[]"
        }
      ],
      "payable": false,
      "stateMutability": "view",
      "type": "function"
    },
    {
      "constant": true,
      "inputs": [
        {
          "name": "author",
          "type": "address"
        },
        {
          "name": "start",
          "type": "uint256"
        },
        {
          "name": "length",
          "type": "uint256"
        }
      ],
      "name": "listByAuthor",
      "outputs": [
        {
          "name": "_fileContracts",
          "type": "address[]"
        }
      ],
      "payable": false,
      "stateMutability": "view",
      "type": "function"
    }
  ];

  const ipfs = new Ipfs({ repo: 'ipfs-' + Math.random() })

    ipfs.once('ready', () => {
      console.log('Online status: ', ipfs.isOnline() ? 'online' : 'offline')

      document.getElementById("status").innerHTML= 'IPFS Node status: ' + (ipfs.isOnline() ? 'online' : 'offline')

      // You can write more code here to use it. Use methods like 
      // node.files.add, node.files.get. See the API docs here:
      // https://github.com/ipfs/interface-ipfs-core
    })

  var web3js;
  if(web3 != undefined) {
    web3js = new Web3(web3.currentProvider);
    crc = web3js.eth.contract(abi).at("0x172d497058aff24628c965336b149c64455055dd");
    crc.list(0,10, function(err,result){
      console.log(result);
      document.getElementById('list1').innerHTML = document.getElementById('list1').innerHTML + result.join("<br>")
    });
  }
  else {
    document.getElementById('list1').innerHTML="请使用chrome浏览器并安装metamask，<a href='https://chrome.google.com/webstore/detail/metamask/nkbihfbeogaeaoehlefnkodbefgpgknn' target='_blank'>点击安装</a>";
  }
  
</script>

</html>